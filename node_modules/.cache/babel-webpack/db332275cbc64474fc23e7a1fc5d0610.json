{"ast":null,"code":"import _asyncToGenerator from \"/Users/homero/fereg-call/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport { forkJoin } from 'rxjs';\nimport { take } from 'rxjs/operators';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/router\";\nimport * as i2 from \"ngx-agora-sdk-ng\";\nimport * as i3 from \"../../shared/services/media.service\";\nimport * as i4 from \"../../shared/services/token.service\";\nimport * as i5 from \"../../shared/components/meeting-controls/meeting-controls.component\";\nconst _c0 = [\"localVideo\"];\nexport class MeetingPageComponent {\n  constructor(activatedRoute, agoraService, mediaService, tokenService, router) {\n    this.activatedRoute = activatedRoute;\n    this.agoraService = agoraService;\n    this.mediaService = mediaService;\n    this.tokenService = tokenService;\n    this.router = router;\n    this.link = '';\n    this.channel = '';\n    this.subscriptions = [];\n    this.userList = [];\n    this.audioInId = '';\n    this.videoInId = '';\n    this.audioOutId = '';\n    this.token = '';\n  }\n\n  ngOnInit() {\n    forkJoin([this.activatedRoute.queryParams.pipe(take(1)), this.mediaService.selectedAudioInputId.pipe(take(1)), this.mediaService.selectedAudioOutputId.pipe(take(1)), this.mediaService.selectedVideoInputId.pipe(take(1))]).pipe(take(1)).subscribe(([params, aInId, aOutId, vInId]) => {\n      this.link = params.link;\n      this.channel = params.channel;\n\n      if (this.link) {\n        const result = this.tokenService.getChannel(this.link);\n\n        if (result.error) {\n          alert(result.error);\n          this.router.navigate(['/..']);\n          return;\n        }\n\n        this.channel = result.channel;\n      }\n\n      this.tokenService.getToken(this.channel);\n      this.audioInId = aInId;\n      this.videoInId = vInId;\n      this.audioOutId = aOutId;\n    });\n    const tokenSub = this.tokenService.token.pipe(take(1)).subscribe(token => {\n      this.token = token;\n      this.joinVideo();\n    });\n    this.subscriptions.push(tokenSub);\n    const remoteUserLeaveSubs = this.agoraService.onRemoteUserLeft().subscribe(leftuser => {\n      var _a;\n\n      this.userList = this.userList.filter(user => {\n        var _a;\n\n        return ((_a = user.user) === null || _a === void 0 ? void 0 : _a.uid) !== leftuser.user.uid;\n      });\n\n      if (this.pinnedUser && ((_a = this.pinnedUser.user) === null || _a === void 0 ? void 0 : _a.uid) && this.pinnedUser.user.uid === leftuser.user.uid) {\n        this.pinnedUser = null;\n      }\n    });\n    this.subscriptions.push(remoteUserLeaveSubs);\n    const remoteUserChangeSubs = this.agoraService.onRemoteUsersStatusChange().subscribe(status => {\n      var _a;\n\n      switch (status.connectionState) {\n        case 'CONNECTED':\n          if (!this.userList.find(user => {\n            var _a;\n\n            return ((_a = user.user) === null || _a === void 0 ? void 0 : _a.uid) === status.user.uid;\n          })) {\n            this.userList.push({\n              type: 'remote',\n              user: status.user\n            });\n          }\n\n          break;\n\n        case 'DISCONNECTED':\n        case 'DISCONNECTING':\n        case 'RECONNECTING':\n          const currentUserIndex = this.userList.findIndex(user => {\n            var _a;\n\n            return ((_a = user.user) === null || _a === void 0 ? void 0 : _a.uid) === status.user.uid;\n          });\n\n          if (currentUserIndex >= 0) {\n            this.userList[currentUserIndex] = {\n              type: 'remote',\n              user: status.user\n            };\n\n            if (this.pinnedUser && ((_a = this.pinnedUser.user) === null || _a === void 0 ? void 0 : _a.uid) && this.pinnedUser.user.uid === status.user.uid) {\n              this.pinnedUser = {\n                type: 'remote',\n                user: status.user\n              };\n            }\n          }\n\n          break;\n      }\n    });\n    this.subscriptions.push(remoteUserChangeSubs);\n    const localUserJoinedSubs = this.agoraService.onLocalUserJoined().subscribe(track => {\n      this.userList.push({\n        type: 'local',\n        mediaTrack: track.track\n      });\n    });\n    this.subscriptions.push(localUserJoinedSubs);\n  }\n\n  ngOnDestroy() {\n    for (const sub of this.subscriptions) {\n      sub.unsubscribe();\n    }\n  }\n\n  joinVideo() {\n    var _this = this;\n\n    return _asyncToGenerator(function* () {\n      yield _this.agoraService.joinAudio(_this.channel, _this.token).Apply();\n    })();\n  }\n\n  onLocalMic(value) {\n    var _a, _b;\n\n    !value ? (_a = this.mediaTrack) === null || _a === void 0 ? void 0 : _a.microphoneUnMute() : (_b = this.mediaTrack) === null || _b === void 0 ? void 0 : _b.microphoneMute();\n  }\n\n  onLocalCamera(value) {\n    var _a, _b;\n\n    !value ? (_a = this.mediaTrack) === null || _a === void 0 ? void 0 : _a.cameraOn() : (_b = this.mediaTrack) === null || _b === void 0 ? void 0 : _b.cameraOff();\n  }\n\n  onLocalPinned(value) {\n    const localuser = this.userList.find(user => user.type === 'local');\n\n    if (localuser) {\n      this.onPin(localuser);\n    }\n  }\n\n  onLocalLeave() {\n    var _a;\n\n    this.agoraService.leave();\n    (_a = this.mediaTrack) === null || _a === void 0 ? void 0 : _a.stop();\n    this.router.navigate(['/..']);\n  }\n\n  onPin(user) {\n    var _a, _b, _c, _d, _e;\n\n    if (user.type === 'local') {\n      if (this.pinnedUser && ((_a = this.pinnedUser) === null || _a === void 0 ? void 0 : _a.type) === 'local') {\n        this.pinnedUser = null;\n        return;\n      }\n\n      this.pinnedUser = user;\n      return;\n    }\n\n    if (((_b = this.pinnedUser) === null || _b === void 0 ? void 0 : _b.type) === 'local') {\n      this.pinnedUser = user;\n      return;\n    }\n\n    if (((_d = (_c = this.pinnedUser) === null || _c === void 0 ? void 0 : _c.user) === null || _d === void 0 ? void 0 : _d.uid) === ((_e = user.user) === null || _e === void 0 ? void 0 : _e.uid)) {\n      this.pinnedUser = null;\n    } else {\n      this.pinnedUser = user;\n    }\n  }\n\n  getUnpinnedUsers() {\n    var _a;\n\n    if (((_a = this.pinnedUser) === null || _a === void 0 ? void 0 : _a.type) === 'local') {\n      return this.userList.filter(user => user.type !== 'local');\n    }\n\n    return this.userList.filter(user => {\n      var _a, _b, _c;\n\n      return ((_a = user.user) === null || _a === void 0 ? void 0 : _a.uid) !== ((_c = (_b = this.pinnedUser) === null || _b === void 0 ? void 0 : _b.user) === null || _c === void 0 ? void 0 : _c.uid);\n    });\n  }\n\n}\n\nMeetingPageComponent.ɵfac = function MeetingPageComponent_Factory(t) {\n  return new (t || MeetingPageComponent)(i0.ɵɵdirectiveInject(i1.ActivatedRoute), i0.ɵɵdirectiveInject(i2.NgxAgoraSdkNgService), i0.ɵɵdirectiveInject(i3.MediaService), i0.ɵɵdirectiveInject(i4.TokenService), i0.ɵɵdirectiveInject(i1.Router));\n};\n\nMeetingPageComponent.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n  type: MeetingPageComponent,\n  selectors: [[\"app-meeting-page\"]],\n  viewQuery: function MeetingPageComponent_Query(rf, ctx) {\n    if (rf & 1) {\n      i0.ɵɵviewQuery(_c0, 7);\n    }\n\n    if (rf & 2) {\n      let _t;\n\n      i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.localVideo = _t.first);\n    }\n  },\n  decls: 3,\n  vars: 0,\n  consts: [[1, \"vh-100\", \"vw-100\", \"d-flex\", \"flex-column\", \"position-relative\"], [1, \"controls-container\"], [3, \"cameraMuted\", \"micMuted\", \"hangedUp\", \"pinned\"]],\n  template: function MeetingPageComponent_Template(rf, ctx) {\n    if (rf & 1) {\n      i0.ɵɵelementStart(0, \"div\", 0);\n      i0.ɵɵelementStart(1, \"div\", 1);\n      i0.ɵɵelementStart(2, \"app-meeting-controls\", 2);\n      i0.ɵɵlistener(\"cameraMuted\", function MeetingPageComponent_Template_app_meeting_controls_cameraMuted_2_listener($event) {\n        return ctx.onLocalCamera($event);\n      })(\"micMuted\", function MeetingPageComponent_Template_app_meeting_controls_micMuted_2_listener($event) {\n        return ctx.onLocalMic($event);\n      })(\"hangedUp\", function MeetingPageComponent_Template_app_meeting_controls_hangedUp_2_listener() {\n        return ctx.onLocalLeave();\n      })(\"pinned\", function MeetingPageComponent_Template_app_meeting_controls_pinned_2_listener($event) {\n        return ctx.onLocalPinned($event);\n      });\n      i0.ɵɵelementEnd();\n      i0.ɵɵelementEnd();\n      i0.ɵɵelementEnd();\n    }\n  },\n  directives: [i5.MeetingControlsComponent],\n  styles: [\".views-container[_ngcontent-%COMP%] {\\n  margin: 0;\\n  padding-top: 1rem;\\n}\\n\\n.controls-container[_ngcontent-%COMP%] {\\n  width: 100%;\\n}\\n\\n.pinned-container[_ngcontent-%COMP%] {\\n  width: 100%;\\n}\\n\\n@media (min-width: 768px) {\\n  .pinned-container[_ngcontent-%COMP%] {\\n    width: 65%;\\n  }\\n}\\n\\n.side-container[_ngcontent-%COMP%] {\\n  overflow-y: scroll;\\n}\\n\\n.meeting-description-container[_ngcontent-%COMP%] {\\n  position: absolute;\\n  left: 0.5rem;\\n  bottom: 0;\\n  height: 3rem;\\n  padding: 10px;\\n  background-color: white;\\n  border-top-right-radius: 0.5rem;\\n  box-shadow: 5px -5px 10px rgba(0, 0, 0, 0.35);\\n}\\n\\n.meeting-description-container[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%] {\\n  font-weight: 300;\\n}\\n/*# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1lZXRpbmctcGFnZS5jb21wb25lbnQuc2NzcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtFQUNFLFNBQUE7RUFDQSxpQkFBQTtBQUNGOztBQUVBO0VBQ0UsV0FBQTtBQUNGOztBQUVBO0VBQ0UsV0FBQTtBQUNGOztBQUVBO0VBQ0U7SUFDRSxVQUFBO0VBQ0Y7QUFDRjs7QUFFQTtFQUNFLGtCQUFBO0FBQUY7O0FBR0E7RUFDRSxrQkFBQTtFQUNBLFlBQUE7RUFDQSxTQUFBO0VBQ0EsWUFBQTtFQUNBLGFBQUE7RUFDQSx1QkFBQTtFQUNBLCtCQUFBO0VBQ0EsNkNBQUE7QUFBRjs7QUFHQTtFQUNFLGdCQUFBO0FBQUYiLCJmaWxlIjoibWVldGluZy1wYWdlLmNvbXBvbmVudC5zY3NzIiwic291cmNlc0NvbnRlbnQiOlsiLnZpZXdzLWNvbnRhaW5lciB7XG4gIG1hcmdpbjogMDtcbiAgcGFkZGluZy10b3A6IDFyZW07XG59XG5cbi5jb250cm9scy1jb250YWluZXIge1xuICB3aWR0aDogMTAwJTtcbn1cblxuLnBpbm5lZC1jb250YWluZXIge1xuICB3aWR0aDogMTAwJTtcbn1cblxuQG1lZGlhIChtaW4td2lkdGg6IDc2OHB4KSB7XG4gIC5waW5uZWQtY29udGFpbmVyIHtcbiAgICB3aWR0aDogNjUlO1xuICB9XG59XG5cbi5zaWRlLWNvbnRhaW5lciB7XG4gIG92ZXJmbG93LXk6IHNjcm9sbDtcbn1cblxuLm1lZXRpbmctZGVzY3JpcHRpb24tY29udGFpbmVyIHtcbiAgcG9zaXRpb246IGFic29sdXRlO1xuICBsZWZ0OiAuNXJlbTtcbiAgYm90dG9tOiAwO1xuICBoZWlnaHQ6IDNyZW07XG4gIHBhZGRpbmc6IDEwcHg7XG4gIGJhY2tncm91bmQtY29sb3I6IHdoaXRlO1xuICBib3JkZXItdG9wLXJpZ2h0LXJhZGl1czogLjVyZW07XG4gIGJveC1zaGFkb3c6IDVweCAtNXB4IDEwcHggcmdiYSgwLCAwLCAwLCAuMzUpO1xufVxuXG4ubWVldGluZy1kZXNjcmlwdGlvbi1jb250YWluZXIgaDQge1xuICBmb250LXdlaWdodDogMzAwO1xufVxuXG4iXX0= */\"]\n});","map":{"version":3,"sources":["/Users/homero/fereg-call/src/app/pages/meeting-page/meeting-page.component.ts","/Users/homero/fereg-call/src/app/pages/meeting-page/meeting-page.component.html"],"names":[],"mappings":";AAEA,SAAS,QAAT,QAAuC,MAAvC;AACA,SAAS,IAAT,QAAqB,gBAArB;;;;;;;;AAkBA,OAAM,MAAO,oBAAP,CAA2B;AAa/B,EAAA,WAAA,CACU,cADV,EAEU,YAFV,EAGU,YAHV,EAIU,YAJV,EAKU,MALV,EAKwB;AAJd,SAAA,cAAA,GAAA,cAAA;AACA,SAAA,YAAA,GAAA,YAAA;AACA,SAAA,YAAA,GAAA,YAAA;AACA,SAAA,YAAA,GAAA,YAAA;AACA,SAAA,MAAA,GAAA,MAAA;AAhBV,SAAA,IAAA,GAAO,EAAP;AACA,SAAA,OAAA,GAAU,EAAV;AACA,SAAA,aAAA,GAAgC,EAAhC;AACA,SAAA,QAAA,GAA2B,EAA3B;AACA,SAAA,SAAA,GAAY,EAAZ;AACA,SAAA,SAAA,GAAY,EAAZ;AACA,SAAA,UAAA,GAAa,EAAb;AACA,SAAA,KAAA,GAAQ,EAAR;AAUK;;AAEL,EAAA,QAAQ,GAAA;AACN,IAAA,QAAQ,CAAC,CACP,KAAK,cAAL,CAAoB,WAApB,CAAgC,IAAhC,CAAqC,IAAI,CAAC,CAAD,CAAzC,CADO,EAEP,KAAK,YAAL,CAAkB,oBAAlB,CAAuC,IAAvC,CAA4C,IAAI,CAAC,CAAD,CAAhD,CAFO,EAGP,KAAK,YAAL,CAAkB,qBAAlB,CAAwC,IAAxC,CAA6C,IAAI,CAAC,CAAD,CAAjD,CAHO,EAIP,KAAK,YAAL,CAAkB,oBAAlB,CAAuC,IAAvC,CAA4C,IAAI,CAAC,CAAD,CAAhD,CAJO,CAAD,CAAR,CAMG,IANH,CAOI,IAAI,CAAC,CAAD,CAPR,EAQI,SARJ,CAQc,CAAC,CAAC,MAAD,EAAS,KAAT,EAAgB,MAAhB,EAAwB,KAAxB,CAAD,KAAmC;AAC7C,WAAK,IAAL,GAAY,MAAM,CAAC,IAAnB;AACA,WAAK,OAAL,GAAe,MAAM,CAAC,OAAtB;;AACA,UAAI,KAAK,IAAT,EAAe;AACb,cAAM,MAAM,GAAG,KAAK,YAAL,CAAkB,UAAlB,CAA6B,KAAK,IAAlC,CAAf;;AACA,YAAI,MAAM,CAAC,KAAX,EAAkB;AAChB,UAAA,KAAK,CAAC,MAAM,CAAC,KAAR,CAAL;AACA,eAAK,MAAL,CAAY,QAAZ,CAAqB,CAAC,KAAD,CAArB;AACA;AACD;;AACD,aAAK,OAAL,GAAe,MAAM,CAAC,OAAtB;AACD;;AACD,WAAK,YAAL,CAAkB,QAAlB,CAA2B,KAAK,OAAhC;AACA,WAAK,SAAL,GAAiB,KAAjB;AACA,WAAK,SAAL,GAAiB,KAAjB;AACA,WAAK,UAAL,GAAkB,MAAlB;AACD,KAxBH;AA0BA,UAAM,QAAQ,GAAG,KAAK,YAAL,CAAkB,KAAlB,CAAwB,IAAxB,CAA6B,IAAI,CAAC,CAAD,CAAjC,EAAsC,SAAtC,CAAgD,KAAK,IAAG;AACvE,WAAK,KAAL,GAAa,KAAb;AACA,WAAK,SAAL;AACD,KAHgB,CAAjB;AAIA,SAAK,aAAL,CAAmB,IAAnB,CAAwB,QAAxB;AAEA,UAAM,mBAAmB,GAAG,KAAK,YAAL,CAAkB,gBAAlB,GAAqC,SAArC,CAA+C,QAAQ,IAAG;;;AACpF,WAAK,QAAL,GAAgB,KAAK,QAAL,CAAc,MAAd,CAAqB,IAAI,IAAG;AAAA,YAAA,EAAA;;AAAC,eAAA,CAAA,CAAA,EAAA,GAAA,IAAI,CAAC,IAAL,MAAS,IAAT,IAAS,EAAA,KAAA,KAAA,CAAT,GAAS,KAAA,CAAT,GAAS,EAAA,CAAE,GAAX,MAAmB,QAAQ,CAAC,IAAT,CAAc,GAAjC;AAAoC,OAAjE,CAAhB;;AACA,UAAI,KAAK,UAAL,KAAmB,CAAA,EAAA,GAAA,KAAK,UAAL,CAAgB,IAAhB,MAAoB,IAApB,IAAoB,EAAA,KAAA,KAAA,CAApB,GAAoB,KAAA,CAApB,GAAoB,EAAA,CAAE,GAAzC,KAAgD,KAAK,UAAL,CAAgB,IAAhB,CAAqB,GAArB,KAA6B,QAAQ,CAAC,IAAT,CAAc,GAA/F,EAAoG;AAClG,aAAK,UAAL,GAAkB,IAAlB;AACD;AACF,KAL2B,CAA5B;AAMA,SAAK,aAAL,CAAmB,IAAnB,CAAwB,mBAAxB;AAEA,UAAM,oBAAoB,GAAG,KAAK,YAAL,CAAkB,yBAAlB,GAA8C,SAA9C,CAAwD,MAAM,IAAG;;;AAC5F,cAAQ,MAAM,CAAC,eAAf;AACE,aAAK,WAAL;AACE,cAAI,CAAC,KAAK,QAAL,CAAc,IAAd,CAAmB,IAAI,IAAG;AAAA,gBAAA,EAAA;;AAAC,mBAAA,CAAA,CAAA,EAAA,GAAA,IAAI,CAAC,IAAL,MAAS,IAAT,IAAS,EAAA,KAAA,KAAA,CAAT,GAAS,KAAA,CAAT,GAAS,EAAA,CAAE,GAAX,MAAmB,MAAM,CAAC,IAAP,CAAY,GAA/B;AAAkC,WAA7D,CAAL,EAAqE;AACnE,iBAAK,QAAL,CAAc,IAAd,CAAmB;AAAE,cAAA,IAAI,EAAE,QAAR;AAAkB,cAAA,IAAI,EAAE,MAAM,CAAC;AAA/B,aAAnB;AACD;;AACD;;AACF,aAAK,cAAL;AACA,aAAK,eAAL;AACA,aAAK,cAAL;AACE,gBAAM,gBAAgB,GAAG,KAAK,QAAL,CAAc,SAAd,CAAwB,IAAI,IAAG;AAAA,gBAAA,EAAA;;AAAC,mBAAA,CAAA,CAAA,EAAA,GAAA,IAAI,CAAC,IAAL,MAAS,IAAT,IAAS,EAAA,KAAA,KAAA,CAAT,GAAS,KAAA,CAAT,GAAS,EAAA,CAAE,GAAX,MAAmB,MAAM,CAAC,IAAP,CAAY,GAA/B;AAAkC,WAAlE,CAAzB;;AACA,cAAI,gBAAgB,IAAI,CAAxB,EAA2B;AACzB,iBAAK,QAAL,CAAc,gBAAd,IAAkC;AAAE,cAAA,IAAI,EAAE,QAAR;AAAkB,cAAA,IAAI,EAAE,MAAM,CAAC;AAA/B,aAAlC;;AACA,gBAAI,KAAK,UAAL,KAAmB,CAAA,EAAA,GAAA,KAAK,UAAL,CAAgB,IAAhB,MAAoB,IAApB,IAAoB,EAAA,KAAA,KAAA,CAApB,GAAoB,KAAA,CAApB,GAAoB,EAAA,CAAE,GAAzC,KAAgD,KAAK,UAAL,CAAgB,IAAhB,CAAqB,GAArB,KAA6B,MAAM,CAAC,IAAP,CAAY,GAA7F,EAAkG;AAChG,mBAAK,UAAL,GAAkB;AAAE,gBAAA,IAAI,EAAE,QAAR;AAAkB,gBAAA,IAAI,EAAE,MAAM,CAAC;AAA/B,eAAlB;AACD;AACF;;AACD;AAhBJ;AAkBD,KAnB4B,CAA7B;AAoBA,SAAK,aAAL,CAAmB,IAAnB,CAAwB,oBAAxB;AAEA,UAAM,mBAAmB,GAAG,KAAK,YAAL,CAAkB,iBAAlB,GAAsC,SAAtC,CAAgD,KAAK,IAAG;AAClF,WAAK,QAAL,CAAc,IAAd,CAAmB;AAAE,QAAA,IAAI,EAAE,OAAR;AAAiB,QAAA,UAAU,EAAE,KAAK,CAAC;AAAnC,OAAnB;AACD,KAF2B,CAA5B;AAGA,SAAK,aAAL,CAAmB,IAAnB,CAAwB,mBAAxB;AACD;;AAED,EAAA,WAAW,GAAA;AACT,SAAK,MAAM,GAAX,IAAkB,KAAK,aAAvB,EAAsC;AACpC,MAAA,GAAG,CAAC,WAAJ;AACD;AACF;;AAEK,EAAA,SAAS,GAAA;AAAA;;AAAA;AACb,YAAM,KAAI,CAAC,YAAL,CAAkB,SAAlB,CAA4B,KAAI,CAAC,OAAjC,EAA0C,KAAI,CAAC,KAA/C,EAAsD,KAAtD,EAAN;AADa;AAEd;;AAED,EAAA,UAAU,CAAC,KAAD,EAAe;;;AACvB,KAAC,KAAD,GAAS,CAAA,EAAA,GAAA,KAAK,UAAL,MAAe,IAAf,IAAe,EAAA,KAAA,KAAA,CAAf,GAAe,KAAA,CAAf,GAAe,EAAA,CAAE,gBAAF,EAAxB,GAA+C,CAAA,EAAA,GAAA,KAAK,UAAL,MAAe,IAAf,IAAe,EAAA,KAAA,KAAA,CAAf,GAAe,KAAA,CAAf,GAAe,EAAA,CAAE,cAAF,EAA9D;AACD;;AAED,EAAA,aAAa,CAAC,KAAD,EAAe;;;AAC1B,KAAC,KAAD,GAAS,CAAA,EAAA,GAAA,KAAK,UAAL,MAAe,IAAf,IAAe,EAAA,KAAA,KAAA,CAAf,GAAe,KAAA,CAAf,GAAe,EAAA,CAAE,QAAF,EAAxB,GAAuC,CAAA,EAAA,GAAA,KAAK,UAAL,MAAe,IAAf,IAAe,EAAA,KAAA,KAAA,CAAf,GAAe,KAAA,CAAf,GAAe,EAAA,CAAE,SAAF,EAAtD;AACD;;AAED,EAAA,aAAa,CAAC,KAAD,EAAe;AAC1B,UAAM,SAAS,GAAG,KAAK,QAAL,CAAc,IAAd,CAAmB,IAAI,IAAI,IAAI,CAAC,IAAL,KAAc,OAAzC,CAAlB;;AACA,QAAI,SAAJ,EAAe;AACb,WAAK,KAAL,CAAW,SAAX;AACD;AACF;;AAED,EAAA,YAAY,GAAA;;;AACV,SAAK,YAAL,CAAkB,KAAlB;AACA,KAAA,EAAA,GAAA,KAAK,UAAL,MAAe,IAAf,IAAe,EAAA,KAAA,KAAA,CAAf,GAAe,KAAA,CAAf,GAAe,EAAA,CAAE,IAAF,EAAf;AACA,SAAK,MAAL,CAAY,QAAZ,CAAqB,CAAC,KAAD,CAArB;AACD;;AAED,EAAA,KAAK,CAAC,IAAD,EAAmB;;;AACtB,QAAI,IAAI,CAAC,IAAL,KAAc,OAAlB,EAA2B;AACzB,UAAI,KAAK,UAAL,IAAmB,CAAA,CAAA,EAAA,GAAA,KAAK,UAAL,MAAe,IAAf,IAAe,EAAA,KAAA,KAAA,CAAf,GAAe,KAAA,CAAf,GAAe,EAAA,CAAE,IAAjB,MAA0B,OAAjD,EAA0D;AACxD,aAAK,UAAL,GAAkB,IAAlB;AACA;AACD;;AACD,WAAK,UAAL,GAAkB,IAAlB;AACA;AACD;;AACD,QAAI,CAAA,CAAA,EAAA,GAAA,KAAK,UAAL,MAAe,IAAf,IAAe,EAAA,KAAA,KAAA,CAAf,GAAe,KAAA,CAAf,GAAe,EAAA,CAAE,IAAjB,MAA0B,OAA9B,EAAuC;AACrC,WAAK,UAAL,GAAkB,IAAlB;AACA;AACD;;AACD,QAAI,CAAA,CAAA,EAAA,GAAA,CAAA,EAAA,GAAA,KAAK,UAAL,MAAe,IAAf,IAAe,EAAA,KAAA,KAAA,CAAf,GAAe,KAAA,CAAf,GAAe,EAAA,CAAE,IAAjB,MAAqB,IAArB,IAAqB,EAAA,KAAA,KAAA,CAArB,GAAqB,KAAA,CAArB,GAAqB,EAAA,CAAE,GAAvB,OAA+B,CAAA,EAAA,GAAA,IAAI,CAAC,IAAL,MAAS,IAAT,IAAS,EAAA,KAAA,KAAA,CAAT,GAAS,KAAA,CAAT,GAAS,EAAA,CAAE,GAA1C,CAAJ,EAAmD;AACjD,WAAK,UAAL,GAAkB,IAAlB;AACD,KAFD,MAEO;AACL,WAAK,UAAL,GAAkB,IAAlB;AACD;AACF;;AAED,EAAA,gBAAgB,GAAA;;;AACd,QAAI,CAAA,CAAA,EAAA,GAAA,KAAK,UAAL,MAAe,IAAf,IAAe,EAAA,KAAA,KAAA,CAAf,GAAe,KAAA,CAAf,GAAe,EAAA,CAAE,IAAjB,MAA0B,OAA9B,EAAuC;AACrC,aAAO,KAAK,QAAL,CAAc,MAAd,CAAqB,IAAI,IAAI,IAAI,CAAC,IAAL,KAAc,OAA3C,CAAP;AACD;;AACD,WAAO,KAAK,QAAL,CAAc,MAAd,CAAqB,IAAI,IAAG;AAAA,UAAA,EAAA,EAAA,EAAA,EAAA,EAAA;;AAAC,aAAA,CAAA,CAAA,EAAA,GAAA,IAAI,CAAC,IAAL,MAAS,IAAT,IAAS,EAAA,KAAA,KAAA,CAAT,GAAS,KAAA,CAAT,GAAS,EAAA,CAAE,GAAX,OAAmB,CAAA,EAAA,GAAA,CAAA,EAAA,GAAA,KAAK,UAAL,MAAe,IAAf,IAAe,EAAA,KAAA,KAAA,CAAf,GAAe,KAAA,CAAf,GAAe,EAAA,CAAE,IAAjB,MAAqB,IAArB,IAAqB,EAAA,KAAA,KAAA,CAArB,GAAqB,KAAA,CAArB,GAAqB,EAAA,CAAE,GAA1C,CAAA;AAA6C,KAA1E,CAAP;AACD;;AAlJ8B;;;mBAApB,oB,EAAoB,EAAA,CAAA,iBAAA,CAAA,EAAA,CAAA,cAAA,C,EAAA,EAAA,CAAA,iBAAA,CAAA,EAAA,CAAA,oBAAA,C,EAAA,EAAA,CAAA,iBAAA,CAAA,EAAA,CAAA,YAAA,C,EAAA,EAAA,CAAA,iBAAA,CAAA,EAAA,CAAA,YAAA,C,EAAA,EAAA,CAAA,iBAAA,CAAA,EAAA,CAAA,MAAA,C;AAAA,C;;;QAApB,oB;AAAoB,EAAA,SAAA,EAAA,CAAA,CAAA,kBAAA,CAAA,C;AAAA,EAAA,SAAA,EAAA,SAAA,0BAAA,CAAA,EAAA,EAAA,GAAA,EAAA;AAAA,QAAA,EAAA,GAAA,CAAA,EAAA;;;;;;;;;;;;;;;ACrBjC,MAAA,EAAA,CAAA,cAAA,CAAA,CAAA,EAAA,KAAA,EAAA,CAAA;AAEE,MAAA,EAAA,CAAA,cAAA,CAAA,CAAA,EAAA,KAAA,EAAA,CAAA;AACE,MAAA,EAAA,CAAA,cAAA,CAAA,CAAA,EAAA,sBAAA,EAAA,CAAA;AAAsB,MAAA,EAAA,CAAA,UAAA,CAAA,aAAA,EAAA,SAAA,yEAAA,CAAA,MAAA,EAAA;AAAA,eAAe,GAAA,CAAA,aAAA,CAAA,MAAA,CAAf;AAAoC,OAApC,EAAqC,UAArC,EAAqC,SAAA,sEAAA,CAAA,MAAA,EAAA;AAAA,eAAa,GAAA,CAAA,UAAA,CAAA,MAAA,CAAb;AAAA,OAArC,EAAqC,UAArC,EAAqC,SAAA,sEAAA,GAAA;AAAA,eAC7C,GAAA,CAAA,YAAA,EAD6C;AAAA,OAArC,EAAqC,QAArC,EAAqC,SAAA,oEAAA,CAAA,MAAA,EAAA;AAAA,eACnB,GAAA,CAAA,aAAA,CAAA,MAAA,CADmB;AAAA,OAArC;AACyC,MAAA,EAAA,CAAA,YAAA;AACjE,MAAA,EAAA,CAAA,YAAA;AACF,MAAA,EAAA,CAAA,YAAA","sourcesContent":["import { ChangeDetectionStrategy, Component, ElementRef, OnDestroy, OnInit, ViewChild } from '@angular/core';\nimport { ActivatedRoute, Router } from '@angular/router';\nimport { forkJoin, Subscription } from 'rxjs';\nimport { take } from 'rxjs/operators';\nimport { IMediaTrack, IRemoteUser, NgxAgoraSdkNgService } from 'ngx-agora-sdk-ng';\n\nimport { MediaService } from '../../shared/services/media.service';\nimport { TokenService } from '../../shared/services/token.service';\n\n\nexport interface IMeetingUser {\n  type: 'local' | 'remote';\n  user?: IRemoteUser;\n  mediaTrack?: IMediaTrack;\n}\n\n@Component({\n  selector: 'app-meeting-page',\n  templateUrl: './meeting-page.component.html',\n  styleUrls: ['./meeting-page.component.scss'],\n})\nexport class MeetingPageComponent implements OnInit, OnDestroy {\n  @ViewChild('localVideo', { static: true }) localVideo?: ElementRef;\n  link = '';\n  channel = '';\n  subscriptions: Subscription[] = [];\n  userList: IMeetingUser[] = [];\n  audioInId = '';\n  videoInId = '';\n  audioOutId = '';\n  token = '';\n  mediaTrack?: IMediaTrack;\n  pinnedUser?: IMeetingUser | null;\n\n  constructor(\n    private activatedRoute: ActivatedRoute,\n    private agoraService: NgxAgoraSdkNgService,\n    private mediaService: MediaService,\n    private tokenService: TokenService,\n    private router: Router\n  ) { }\n\n  ngOnInit(): void {\n    forkJoin([\n      this.activatedRoute.queryParams.pipe(take(1)),\n      this.mediaService.selectedAudioInputId.pipe(take(1)),\n      this.mediaService.selectedAudioOutputId.pipe(take(1)),\n      this.mediaService.selectedVideoInputId.pipe(take(1)),\n    ])\n      .pipe(\n        take(1),\n      ).subscribe(([params, aInId, aOutId, vInId]) => {\n        this.link = params.link;\n        this.channel = params.channel;\n        if (this.link) {\n          const result = this.tokenService.getChannel(this.link);\n          if (result.error) {\n            alert(result.error);\n            this.router.navigate(['/..']);\n            return;\n          }\n          this.channel = result.channel as string;\n        }\n        this.tokenService.getToken(this.channel);\n        this.audioInId = aInId;\n        this.videoInId = vInId;\n        this.audioOutId = aOutId;\n      });\n\n    const tokenSub = this.tokenService.token.pipe(take(1)).subscribe(token => {\n      this.token = token;\n      this.joinVideo();\n    });\n    this.subscriptions.push(tokenSub);\n\n    const remoteUserLeaveSubs = this.agoraService.onRemoteUserLeft().subscribe(leftuser => {\n      this.userList = this.userList.filter(user => user.user?.uid !== leftuser.user.uid);\n      if (this.pinnedUser && this.pinnedUser.user?.uid && this.pinnedUser.user.uid === leftuser.user.uid) {\n        this.pinnedUser = null;\n      }\n    });\n    this.subscriptions.push(remoteUserLeaveSubs);\n\n    const remoteUserChangeSubs = this.agoraService.onRemoteUsersStatusChange().subscribe(status => {\n      switch (status.connectionState) {\n        case 'CONNECTED':\n          if (!this.userList.find(user => user.user?.uid === status.user.uid)) {\n            this.userList.push({ type: 'remote', user: status.user });\n          }\n          break;\n        case 'DISCONNECTED':\n        case 'DISCONNECTING':\n        case 'RECONNECTING':\n          const currentUserIndex = this.userList.findIndex(user => user.user?.uid === status.user.uid);\n          if (currentUserIndex >= 0) {\n            this.userList[currentUserIndex] = { type: 'remote', user: status.user };\n            if (this.pinnedUser && this.pinnedUser.user?.uid && this.pinnedUser.user.uid === status.user.uid) {\n              this.pinnedUser = { type: 'remote', user: status.user };\n            }\n          }\n          break;\n      }\n    });\n    this.subscriptions.push(remoteUserChangeSubs);\n\n    const localUserJoinedSubs = this.agoraService.onLocalUserJoined().subscribe(track => {\n      this.userList.push({ type: 'local', mediaTrack: track.track });\n    });\n    this.subscriptions.push(localUserJoinedSubs);\n  }\n\n  ngOnDestroy(): void {\n    for (const sub of this.subscriptions) {\n      sub.unsubscribe();\n    }\n  }\n\n  async joinVideo(): Promise<void> {\n    await this.agoraService.joinAudio(this.channel, this.token).Apply();\n  }\n\n  onLocalMic(value: boolean): void {\n    !value ? this.mediaTrack?.microphoneUnMute() : this.mediaTrack?.microphoneMute();\n  }\n\n  onLocalCamera(value: boolean): void {\n    !value ? this.mediaTrack?.cameraOn() : this.mediaTrack?.cameraOff();\n  }\n\n  onLocalPinned(value: boolean): void {\n    const localuser = this.userList.find(user => user.type === 'local');\n    if (localuser) {\n      this.onPin(localuser);\n    }\n  }\n\n  onLocalLeave(): void {\n    this.agoraService.leave();\n    this.mediaTrack?.stop();\n    this.router.navigate(['/..']);\n  }\n\n  onPin(user: IMeetingUser): void {\n    if (user.type === 'local') {\n      if (this.pinnedUser && this.pinnedUser?.type === 'local') {\n        this.pinnedUser = null;\n        return;\n      }\n      this.pinnedUser = user;\n      return;\n    }\n    if (this.pinnedUser?.type === 'local') {\n      this.pinnedUser = user;\n      return;\n    }\n    if (this.pinnedUser?.user?.uid === user.user?.uid) {\n      this.pinnedUser = null;\n    } else {\n      this.pinnedUser = user;\n    }\n  }\n\n  getUnpinnedUsers(): IMeetingUser[] {\n    if (this.pinnedUser?.type === 'local') {\n      return this.userList.filter(user => user.type !== 'local');\n    }\n    return this.userList.filter(user => user.user?.uid !== this.pinnedUser?.user?.uid);\n  }\n}\n","<div class=\"vh-100 vw-100 d-flex flex-column position-relative\">\n  \n  <div class=\"controls-container\">\n    <app-meeting-controls (cameraMuted)=\"onLocalCamera($event)\" (micMuted)=\"onLocalMic($event)\"\n      (hangedUp)=\"onLocalLeave()\" (pinned)=\"onLocalPinned($event)\"></app-meeting-controls>\n  </div>\n</div>"],"sourceRoot":""},"metadata":{},"sourceType":"module"}